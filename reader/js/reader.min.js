!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(e.RSVP={})}(this,function(e){"use strict";function i(e){var t=e._promiseCallbacks;return t=t||(e._promiseCallbacks={})}var t={mixin:function(e){return e.on=this.on,e.off=this.off,e.trigger=this.trigger,e._promiseCallbacks=void 0,e},on:function(e,t){if("function"!=typeof t)throw new TypeError("Callback must be a function");var n=i(this),r=n[e];-1===(r=r||(n[e]=[])).indexOf(t)&&r.push(t)},off:function(e,t){var n=i(this);if(t){var r=n[e],o=r.indexOf(t);-1!==o&&r.splice(o,1)}else n[e]=[]},trigger:function(e,t,n){var r=i(this)[e];if(r)for(var o=0;o<r.length;o++)(0,r[o])(t,n)}},c={instrument:!1};function n(e,t){if(2!==arguments.length)return c[e];c[e]=t}t.mixin(c);var r=[];function l(e,t,n){1===r.push({name:e,payload:{key:t._guidKey,id:t._id,eventName:e,detail:t._result,childId:n&&n._id,label:t._label,timeStamp:Date.now(),error:c["instrument-with-stack"]?new Error(t._label):null}})&&setTimeout(function(){for(var e=0;e<r.length;e++){var t=r[e],n=t.payload;n.guid=n.key+n.id,n.childGuid=n.key+n.childId,n.error&&(n.stack=n.error.stack),c.trigger(t.name,t.payload)}r.length=0},50)}function o(e,t){if(e&&"object"==typeof e&&e.constructor===this)return e;var n=new this(u,t);return g(n,e),n}function u(){}var d=void 0,f=1,h=2,p={error:null};function s(e){try{return e.then}catch(e){return p.error=e,p}}var a=void 0;function m(){try{var e=a;return a=null,e.apply(this,arguments)}catch(e){return p.error=e,p}}function y(e){return a=e,m}function v(e,t,n){if(t.constructor===e.constructor&&n===P&&e.constructor.resolve===o)!function(t,n){n._state===f?E(t,n._result):n._state===h?(n._onError=null,w(t,n._result)):S(n,void 0,function(e){n===e?E(t,e):g(t,e)},function(e){return w(t,e)})}(e,t);else if(n===p){var r=p.error;p.error=null,w(e,r)}else"function"==typeof n?function(e,o,i){c.async(function(t){var n=!1,e=y(i).call(o,function(e){n||(n=!0,o===e?E(t,e):g(t,e))},function(e){n||(n=!0,w(t,e))},"Settle: "+(t._label||" unknown promise"));if(!n&&e===p){n=!0;var r=p.error;p.error=null,w(t,r)}},e)}(e,t,n):E(e,t)}function g(e,t){e===t?E(e,t):!function(e){var t=typeof e;return null!==e&&("object"==t||"function"==t)}(t)?E(e,t):v(e,t,s(t))}function b(e){e._onError&&e._onError(e._result),_(e)}function E(e,t){e._state===d&&(e._result=t,e._state=f,0===e._subscribers.length?c.instrument&&l("fulfilled",e):c.async(_,e))}function w(e,t){e._state===d&&(e._state=h,e._result=t,c.async(b,e))}function S(e,t,n,r){var o=e._subscribers,i=o.length;e._onError=null,o[i]=t,o[i+f]=n,o[i+h]=r,0===i&&e._state&&c.async(_,e)}function _(e){var t=e._subscribers,n=e._state;if(c.instrument&&l(n===f?"fulfilled":"rejected",e),0!==t.length){for(var r=void 0,o=void 0,i=e._result,s=0;s<t.length;s+=3)r=t[s],o=t[s+n],r?k(n,r,o,i):o(i);e._subscribers.length=0}}function k(e,t,n,r){var o="function"==typeof n,i=void 0;if(i=o?y(n)(r):r,t._state!==d);else if(i===t)w(t,new TypeError("A promises callback cannot return that same promise."));else if(i===p){var s=p.error;p.error=null,w(t,s)}else o?g(t,i):e===f?E(t,i):e===h&&w(t,i)}function P(e,t,n){var r=this,o=r._state;if(o===f&&!e||o===h&&!t)return c.instrument&&l("chained",r,r),r;r._onError=null;var i=new r.constructor(u,n),s=r._result;if(c.instrument&&l("chained",r,i),o===d)S(r,i,e,t);else{var a=o===f?e:t;c.async(function(){return k(o,i,a,s)})}return i}var C=(x.prototype._init=function(e,t){var n=t.length||0;this.length=n,this._remaining=n,this._result=new Array(n),this._enumerate(t)},x.prototype._enumerate=function(e){for(var t=this.length,n=this.promise,r=0;n._state===d&&r<t;r++)this._eachEntry(e[r],r,!0);this._checkFullfillment()},x.prototype._checkFullfillment=function(){if(0===this._remaining){var e=this._result;E(this.promise,e),this._result=null}},x.prototype._settleMaybeThenable=function(t,e,n){var r=this._instanceConstructor;if(this._isUsingOwnResolve){var o=s(t);if(o===P&&t._state!==d)t._onError=null,this._settledAt(t._state,e,t._result,n);else if("function"!=typeof o)this._settledAt(f,e,t,n);else if(this._isUsingOwnPromise){var i=new r(u);v(i,t,o),this._willSettleAt(i,e,n)}else this._willSettleAt(new r(function(e){return e(t)}),e,n)}else this._willSettleAt(r.resolve(t),e,n)},x.prototype._eachEntry=function(e,t,n){null!==e&&"object"==typeof e?this._settleMaybeThenable(e,t,n):this._setResultAt(f,t,e,n)},x.prototype._settledAt=function(e,t,n,r){var o=this.promise;o._state===d&&(this._abortOnReject&&e===h?w(o,n):(this._setResultAt(e,t,n,r),this._checkFullfillment()))},x.prototype._setResultAt=function(e,t,n,r){this._remaining--,this._result[t]=n},x.prototype._willSettleAt=function(e,t,n){var r=this;S(e,void 0,function(e){return r._settledAt(f,t,e,n)},function(e){return r._settledAt(h,t,e,n)})},x);function x(e,t,n,r){this._instanceConstructor=e,this.promise=new e(u,r),this._abortOnReject=n,this._isUsingOwnPromise=e===J,this._isUsingOwnResolve=e.resolve===o,this._init.apply(this,arguments)}function B(e,t,n){this._remaining--,this._result[t]=e===f?{state:"fulfilled",value:n}:{state:"rejected",reason:n}}var U="rsvp_"+Date.now()+"-",O=0;var J=(R.prototype._onError=function(e){var t=this;c.after(function(){t._onError&&c.trigger("error",e,t._label)})},R.prototype.catch=function(e,t){return this.then(void 0,e,t)},R.prototype.finally=function(t,e){var n=this.constructor;return"function"==typeof t?this.then(function(e){return n.resolve(t()).then(function(){return e})},function(e){return n.resolve(t()).then(function(){throw e})}):this.then(t,t)},R);function R(e,t){this._id=O++,this._label=t,this._state=void 0,this._result=void 0,this._subscribers=[],c.instrument&&l("created",this),u!==e&&("function"!=typeof e&&function(){throw new TypeError("You must pass a resolver function as the first argument to the promise constructor")}(),this instanceof R?function(t,e){var n=!1;try{e(function(e){n||(n=!0,g(t,e))},function(e){n||(n=!0,w(t,e))})}catch(e){w(t,e)}}(this,e):function(){throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.")}())}function T(n,r){return{then:function(e,t){return n.call(r,e,t)}}}function j(c,l){function e(){for(var e=arguments.length,t=new Array(e+1),n=!1,r=0;r<e;++r){var o=arguments[r];if(!n){if((n=A(o))===p){var i=p.error;p.error=null;var s=new J(u);return w(s,i),s}n&&!0!==n&&(o=T(n,o))}t[r]=o}var a=new J(u);return t[e]=function(e,t){e?w(a,e):void 0===l?g(a,t):!0===l?g(a,function(e){for(var t=e.length,n=new Array(t-1),r=1;r<t;r++)n[r-1]=e[r];return n}(arguments)):Array.isArray(l)?g(a,function(e,t){for(var n={},r=e.length,o=new Array(r),i=0;i<r;i++)o[i]=e[i];for(var s=0;s<t.length;s++){n[t[s]]=o[s+1]}return n}(arguments,l)):g(a,t)},n?function(t,e,n,r){return J.all(e).then(function(e){return N(t,e,n,r)})}(a,t,c,this):N(a,t,c,this)}return e.__proto__=c,e}function N(e,t,n,r){if(y(n).apply(r,t)===p){var o=p.error;p.error=null,w(e,o)}return e}function A(e){return null!==e&&"object"==typeof e&&(e.constructor===J||s(e))}function L(e,t){return J.all(e,t)}J.cast=o,J.all=function(e,t){return Array.isArray(e)?new C(this,e,!0,t).promise:this.reject(new TypeError("Promise.all must be called with an array"),t)},J.race=function(e,t){var n=new this(u,t);if(!Array.isArray(e))return w(n,new TypeError("Promise.race must be called with an array")),n;for(var r=0;n._state===d&&r<e.length;r++)S(this.resolve(e[r]),void 0,function(e){return g(n,e)},function(e){return w(n,e)});return n},J.resolve=o,J.reject=function(e,t){var n=new this(u,t);return w(n,e),n},J.prototype._guidKey=U,J.prototype.then=P;var M,D=(function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}($,M=C),$);function $(e,t,n){return function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,M.call(this,e,t,!1,n))}function F(e,t){return Array.isArray(e)?new D(J,e,t).promise:J.reject(new TypeError("Promise.allSettled must be called with an array"),t)}function I(e,t){return J.race(e,t)}D.prototype._setResultAt=B;var z,X=(function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(K,z=C),K.prototype._init=function(e,t){this._result={},this._enumerate(t)},K.prototype._enumerate=function(e){var t=Object.keys(e),n=t.length,r=this.promise;this._remaining=n;for(var o=void 0,i=void 0,s=0;r._state===d&&s<n;s++)i=e[o=t[s]],this._eachEntry(i,o,!0);this._checkFullfillment()},K);function K(e,t){var n=!(2<arguments.length&&void 0!==arguments[2])||arguments[2],r=arguments[3];return function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,z.call(this,e,t,n,r))}function q(e,t){return J.resolve(e,t).then(function(e){if(null===e||"object"!=typeof e)throw new TypeError("Promise.hash must be called with an object");return new X(J,e,t).promise})}var H,V=(function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(Y,H=X),Y);function Y(e,t,n){return function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,H.call(this,e,t,!1,n))}function G(e,t){return J.resolve(e,t).then(function(e){if(null===e||"object"!=typeof e)throw new TypeError("hashSettled must be called with an object");return new V(J,e,!1,t).promise})}function W(e){throw setTimeout(function(){throw e}),e}function Q(e){var n={resolve:void 0,reject:void 0};return n.promise=new J(function(e,t){n.resolve=e,n.reject=t},e),n}V.prototype._setResultAt=B;var Z,ee=(function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(te,Z=C),te.prototype._init=function(e,t,n,r,o){var i=t.length||0;this.length=i,this._remaining=i,this._result=new Array(i),this._mapFn=o,this._enumerate(t)},te.prototype._setResultAt=function(e,t,n,r){if(r){var o=y(this._mapFn)(n,t);o===p?this._settledAt(h,t,o.error,!1):this._eachEntry(o,t,!1)}else this._remaining--,this._result[t]=n},te);function te(e,t,n,r){return function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,Z.call(this,e,t,!0,r,n))}function ne(e,t,n){return"function"!=typeof t?J.reject(new TypeError("map expects a function as a second argument"),n):J.resolve(e,n).then(function(e){if(!Array.isArray(e))throw new TypeError("map must be called with an array");return new ee(J,e,t,n).promise})}function re(e,t){return J.resolve(e,t)}function oe(e,t){return J.reject(e,t)}var ie,se={},ae=(function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(ce,ie=ee),ce.prototype._checkFullfillment=function(){if(0===this._remaining&&null!==this._result){var e=this._result.filter(function(e){return e!==se});E(this.promise,e),this._result=null}},ce.prototype._setResultAt=function(e,t,n,r){if(r){this._result[t]=n;var o=y(this._mapFn)(n,t);o===p?this._settledAt(h,t,o.error,!1):this._eachEntry(o,t,!1)}else this._remaining--,n||(this._result[t]=se)},ce);function ce(){return function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,ie.apply(this,arguments))}function le(e,t,n){return"function"!=typeof t?J.reject(new TypeError("filter expects function as a second argument"),n):J.resolve(e,n).then(function(e){if(!Array.isArray(e))throw new TypeError("filter must be called with an array");return new ae(J,e,t,n).promise})}var ue=0,de=void 0;function fe(e,t){be[ue]=e,be[ue+1]=t,2===(ue+=2)&&xe()}var he="undefined"!=typeof window?window:void 0,pe=he||{},me=pe.MutationObserver||pe.WebKitMutationObserver,ye="undefined"==typeof self&&"undefined"!=typeof process&&"[object process]"==={}.toString.call(process),ve="undefined"!=typeof Uint8ClampedArray&&"undefined"!=typeof importScripts&&"undefined"!=typeof MessageChannel;function ge(){return function(){return setTimeout(Ee,1)}}var be=new Array(1e3);function Ee(){for(var e=0;e<ue;e+=2){(0,be[e])(be[e+1]),be[e]=void 0,be[e+1]=void 0}ue=0}var we,Se,_e,ke,Pe,Ce,xe=void 0;xe=ye?(Pe=process.nextTick,Ce=process.versions.node.match(/^(?:(\d+)\.)?(?:(\d+)\.)?(\*|\d+)$/),Array.isArray(Ce)&&"0"===Ce[1]&&"10"===Ce[2]&&(Pe=setImmediate),function(){return Pe(Ee)}):me?(Se=0,_e=new me(Ee),ke=document.createTextNode(""),_e.observe(ke,{characterData:!0}),function(){return ke.data=Se=++Se%2}):ve?((we=new MessageChannel).port1.onmessage=Ee,function(){return we.port2.postMessage(0)}):void 0===he&&"function"==typeof require?function(){try{var e=Function("return this")().require("vertx");return void 0!==(de=e.runOnLoop||e.runOnContext)?function(){de(Ee)}:ge()}catch(e){return ge()}}():ge(),c.async=fe,c.after=function(e){return setTimeout(e,0)};function Be(e,t){return c.async(e,t)}var Ue=re;function Oe(){c.on.apply(c,arguments)}function Je(){c.off.apply(c,arguments)}if("undefined"!=typeof window&&"object"==typeof window.__PROMISE_INSTRUMENTATION__){var Re=window.__PROMISE_INSTRUMENTATION__;for(var Te in n("instrument",!0),Re)Re.hasOwnProperty(Te)&&Oe(Te,Re[Te])}var je={asap:fe,cast:Ue,Promise:J,EventTarget:t,all:L,allSettled:F,race:I,hash:q,hashSettled:G,rethrow:W,defer:Q,denodeify:j,configure:n,on:Oe,off:Je,resolve:re,reject:oe,map:ne,async:Be,filter:le};e.default=je,e.asap=fe,e.cast=Ue,e.Promise=J,e.EventTarget=t,e.all=L,e.allSettled=F,e.race=I,e.hash=q,e.hashSettled=G,e.rethrow=W,e.defer=Q,e.denodeify=j,e.configure=n,e.on=Oe,e.off=Je,e.resolve=re,e.reject=oe,e.map=ne,e.async=Be,e.filter=le,Object.defineProperty(e,"__esModule",{value:!0})}),(EPUBJS=EPUBJS||{}).core={};var EPUBJS,ELEMENT_NODE=1,TEXT_NODE=3,COMMENT_NODE=8,DOCUMENT_NODE=9;EPUBJS.core.getEl=function(e){return document.getElementById(e)},EPUBJS.core.getEls=function(e){return document.getElementsByClassName(e)},EPUBJS.core.request=function(e,t,n){var r,o=window.URL,i=o?"blob":"arraybuffer",s=new RSVP.defer,a=new XMLHttpRequest,c=XMLHttpRequest.prototype;return"overrideMimeType"in c||Object.defineProperty(c,"overrideMimeType",{value:function(e){}}),a.onreadystatechange=function(){var e;this.readyState==this.DONE&&(200!==this.status&&0!==this.status||!this.response?s.reject({message:this.response,stack:(new Error).stack}):(e="xml"==t?this.responseXML?this.responseXML:(new DOMParser).parseFromString(this.response,"application/xml"):"xhtml"==t?this.responseXML?this.responseXML:(new DOMParser).parseFromString(this.response,"application/xhtml+xml"):"html"==t?this.responseXML?this.responseXML:(new DOMParser).parseFromString(this.response,"text/html"):"json"==t?JSON.parse(this.response):"blob"==t?o?this.response:new Blob([this.response]):this.response,s.resolve(e)))},a.open("GET",e,!0),n&&(a.withCredentials=!0),t||(r=EPUBJS.core.uri(e),t={htm:"html"}[t=r.extension]||t),"blob"==t&&(a.responseType=i),"json"==t&&a.setRequestHeader("Accept","application/json"),"xml"==t&&(a.responseType="document",a.overrideMimeType("text/xml")),"xhtml"==t&&(a.responseType="document"),"html"==t&&(a.responseType="document"),"binary"==t&&(a.responseType="arraybuffer"),a.send(),s.promise},EPUBJS.core.toArray=function(e){var t=[];for(var n in e){var r;e.hasOwnProperty(n)&&((r=e[n]).ident=n,t.push(r))}return t},EPUBJS.core.uri=function(e){var t,n,r,o={protocol:"",host:"",path:"",origin:"",directory:"",base:"",filename:"",extension:"",fragment:"",href:e},i=e.indexOf("blob:"),s=e.indexOf("://"),a=e.indexOf("?"),c=e.indexOf("#");return 0===i?(o.protocol="blob",o.base=e.indexOf(0,c)):(-1!=c&&(o.fragment=e.slice(c+1),e=e.slice(0,c)),-1!=a&&(o.search=e.slice(a+1),e=e.slice(0,a),href=o.href),-1!=s?(o.protocol=e.slice(0,s),-1===(r=(t=e.slice(s+3)).indexOf("/"))?(o.host=o.path,o.path=""):(o.host=t.slice(0,r),o.path=t.slice(r)),o.origin=o.protocol+"://"+o.host,o.directory=EPUBJS.core.folder(o.path),o.base=o.origin+o.directory):(o.path=e,o.directory=EPUBJS.core.folder(e),o.base=o.directory),o.filename=e.replace(o.base,""),-1!=(n=o.filename.lastIndexOf("."))&&(o.extension=o.filename.slice(n+1))),o},EPUBJS.core.folder=function(e){var t=e.lastIndexOf("/");if(-1==t);return e.slice(0,t+1)},EPUBJS.core.dataURLToBlob=function(e){var t,n,r,o,i,s=";base64,";if(-1==e.indexOf(s))return n=(t=e.split(","))[0].split(":")[1],r=t[1],new Blob([r],{type:n});n=(t=e.split(s))[0].split(":")[1],o=(r=window.atob(t[1])).length,i=new Uint8Array(o);for(var a=0;a<o;++a)i[a]=r.charCodeAt(a);return new Blob([i],{type:n})},EPUBJS.core.addScript=function(e,t,n){var r,o;o=!1,(r=document.createElement("script")).type="text/javascript",r.async=!1,r.src=e,r.onload=r.onreadystatechange=function(){o||this.readyState&&"complete"!=this.readyState||(o=!0,t&&t())},(n=n||document.body).appendChild(r)},EPUBJS.core.addScripts=function(e,t,n){var r=e.length,o=0,i=function(){r==++o?t&&t():EPUBJS.core.addScript(e[o],i,n)};EPUBJS.core.addScript(e[o],i,n)},EPUBJS.core.addCss=function(e,t,n){var r,o;o=!1,(r=document.createElement("link")).type="text/css",r.rel="stylesheet",r.href=e,r.onload=r.onreadystatechange=function(){o||this.readyState&&"complete"!=this.readyState||(o=!0,t&&t())},(n=n||document.body).appendChild(r)},EPUBJS.core.prefixed=function(e){var t=["Webkit","Moz","O","ms"],n=e[0].toUpperCase()+e.slice(1),r=t.length;if(void 0!==document.documentElement.style[e])return e;for(var o=0;o<r;o++)if(void 0!==document.documentElement.style[t[o]+n])return t[o]+n;return e},EPUBJS.core.resolveUrl=function(e,t){var n=[],r=EPUBJS.core.uri(t),o=e.split("/");return r.host?t:(o.pop(),t.split("/").forEach(function(e){".."===e?o.pop():n.push(e)}),o.concat(n).join("/"))},EPUBJS.core.uuid=function(){var n=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=(n+16*Math.random())%16|0;return n=Math.floor(n/16),("x"==e?t:7&t|8).toString(16)})},EPUBJS.core.insert=function(e,t,n){var r=EPUBJS.core.locationOf(e,t,n);return t.splice(r,0,e),r},EPUBJS.core.locationOf=function(e,t,n,r,o){var i,s=r||0,a=o||t.length,c=parseInt(s+(a-s)/2);return a-s<=0?c:(i=(n=n||function(e,t){return t<e?1:e<t?-1:(e=t)?0:void 0})(t[c],e),a-s==1?0<i?c:c+1:0===i?c:-1===i?EPUBJS.core.locationOf(e,t,n,c,a):EPUBJS.core.locationOf(e,t,n,s,c))},EPUBJS.core.indexOfSorted=function(e,t,n,r,o){var i,s=r||0,a=o||t.length,c=parseInt(s+(a-s)/2);return a-s<=0?-1:(i=(n=n||function(e,t){return t<e?1:e<t?-1:(e=t)?0:void 0})(t[c],e),a-s==1?0===i?c:-1:0===i?c:-1===i?EPUBJS.core.indexOfSorted(e,t,n,c,a):EPUBJS.core.indexOfSorted(e,t,n,s,c))},EPUBJS.core.queue=function(e){function t(){var e;r.length&&(e=r.shift(),n[e.funcName].apply(e.context||n,e.args))}var r=[],n=e;return{enqueue:function(e,t,n){return r.push({funcName:e,args:t,context:n}),r},dequeue:t,flush:function(){for(;r.length;)t()},clear:function(){r=[]},length:function(){return r.length}}},EPUBJS.core.getElementXPath=function(e){return e&&e.id?'//*[@id="'+e.id+'"]':EPUBJS.core.getElementTreeXPath(e)},EPUBJS.core.getElementTreeXPath=function(e){var t,n,r,o,i=[],s="http://www.w3.org/1999/xhtml"===e.ownerDocument.documentElement.getAttribute("xmlns");for(e.nodeType===Node.TEXT_NODE&&(t=EPUBJS.core.indexOfTextNode(e)+1,i.push("text()["+t+"]"),e=e.parentNode);e&&1==e.nodeType;e=e.parentNode){t=0;for(var a=e.previousSibling;a;a=a.previousSibling)a.nodeType!=Node.DOCUMENT_TYPE_NODE&&a.nodeName==e.nodeName&&++t;n=e.nodeName.toLowerCase(),r=s?"xhtml:"+n:n,o=t?"["+(t+1)+"]":"",i.splice(0,0,r+o)}return i.length?"./"+i.join("/"):null},EPUBJS.core.nsResolver=function(e){return{xhtml:"http://www.w3.org/1999/xhtml",epub:"http://www.idpf.org/2007/ops"}[e]||null},EPUBJS.core.cleanStringForXpath=function(e){var t=e.match(/[^'"]+|['"]/g);return"concat('',"+(t=t.map(function(e){return"'"===e?'"\'"':'"'===e?"'\"'":"'"+e+"'"})).join(",")+")"},EPUBJS.core.indexOfTextNode=function(e){for(var t,n=e.parentNode.childNodes,r=-1,o=0;o<n.length&&((t=n[o]).nodeType===Node.TEXT_NODE&&r++,t!=e);o++);return r},EPUBJS.core.defaults=function(e){for(var t=1,n=arguments.length;t<n;t++){var r=arguments[t];for(var o in r)void 0===e[o]&&(e[o]=r[o])}return e},EPUBJS.core.extend=function(n){return[].slice.call(arguments,1).forEach(function(t){t&&Object.getOwnPropertyNames(t).forEach(function(e){Object.defineProperty(n,e,Object.getOwnPropertyDescriptor(t,e))})}),n},EPUBJS.core.clone=function(e){return EPUBJS.core.isArray(e)?e.slice():EPUBJS.core.extend({},e)},EPUBJS.core.isElement=function(e){return!(!e||1!=e.nodeType)},EPUBJS.core.isNumber=function(e){return!isNaN(parseFloat(e))&&isFinite(e)},EPUBJS.core.isString=function(e){return"string"==typeof e||e instanceof String},EPUBJS.core.isArray=Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)},EPUBJS.core.values=function(e){var t,n,r,o=-1;if(!e)return[];for(n=(t=Object.keys(e)).length,r=Array(n);++o<n;)r[o]=e[t[o]];return r},EPUBJS.core.indexOfNode=function(e,t){for(var n,r=e.parentNode.childNodes,o=-1,i=0;i<r.length&&((n=r[i]).nodeType===t&&o++,n!=e);i++);return o},EPUBJS.core.indexOfTextNode=function(e){return EPUBJS.core.indexOfNode(e,TEXT_NODE)},EPUBJS.core.indexOfElementNode=function(e){return EPUBJS.core.indexOfNode(e,ELEMENT_NODE)},(EPUBJS=EPUBJS||{}).reader={},EPUBJS.reader.plugins={},function(e){e.ePubReader;var t=e.ePubReader=function(e,t){return new EPUBJS.Reader(e,t)};"function"==typeof define&&define.amd?define(function(){return Reader}):"undefined"!=typeof module&&module.exports&&(module.exports=t)}(window,jQuery),EPUBJS.Reader=function(e,t){var n,r,o=this,i=$("#viewer").empty(),s=window.location.search;for(r in this.settings=EPUBJS.core.defaults(t||{},{bookPath:e,restore:!1,reload:!1,bookmarks:void 0,annotations:void 0,contained:void 0,bookKey:void 0,styles:void 0,sidebarReflow:!1,generatePagination:!1,history:!0}),o.UploadController=EPUBJS.reader.UploadController.call(o),s&&s.slice(1).split("&").forEach(function(e){var t=e.split("="),n=t[0],r=t[1]||"";o.settings[n]=decodeURIComponent(r)}),this.setBookKey(this.settings.bookPath),this.settings.restore&&this.isSaved()&&this.applySavedSettings(),this.settings.styles=this.settings.styles||{fontSize:"100%"},this.book=n=new ePub(this.settings.bookPath,this.settings),this.offline=!1,this.sidebarOpen=!1,this.settings.bookmarks||(this.settings.bookmarks=[]),this.settings.annotations||(this.settings.annotations=[]),this.settings.generatePagination&&n.generatePagination(i.width(),i.height()),this.rendition=n.renderTo("viewer",{ignoreClass:"annotator-hl",width:"100%",height:"100%"}),this.settings.previousLocationCfi?this.displayed=this.rendition.display(this.settings.previousLocationCfi):this.displayed=this.rendition.display(),n.ready.then(function(){o.ReaderController=EPUBJS.reader.ReaderController.call(o,n),o.SettingsController=EPUBJS.reader.SettingsController.call(o,n),o.ControlsController=EPUBJS.reader.ControlsController.call(o,n),o.SidebarController=EPUBJS.reader.SidebarController.call(o,n),o.BookmarksController=EPUBJS.reader.BookmarksController.call(o,n),o.NotesController=EPUBJS.reader.NotesController.call(o,n),window.addEventListener("hashchange",this.hashChanged.bind(this),!1),document.addEventListener("keydown",this.adjustFontSize.bind(this),!1),this.rendition.on("keydown",this.adjustFontSize.bind(this)),this.rendition.on("keydown",o.ReaderController.arrowKeys.bind(this)),this.rendition.on("selected",this.selectedRange.bind(this))}.bind(this)).then(function(){o.ReaderController.hideLoader()}.bind(this)),EPUBJS.reader.plugins)EPUBJS.reader.plugins.hasOwnProperty(r)&&(o[r]=EPUBJS.reader.plugins[r].call(o,n));return n.loaded.metadata.then(function(e){o.MetaController=EPUBJS.reader.MetaController.call(o,e)}),n.loaded.navigation.then(function(e){o.TocController=EPUBJS.reader.TocController.call(o,e)}),window.addEventListener("beforeunload",this.unload.bind(this),!1),this},EPUBJS.Reader.prototype.adjustFontSize=function(e){var t,n=e.ctrlKey||e.metaKey;this.settings.styles&&(this.settings.styles.fontSize||(this.settings.styles.fontSize="100%"),t=parseInt(this.settings.styles.fontSize.slice(0,-1)),n&&187==e.keyCode&&(e.preventDefault(),this.book.setStyle("fontSize",t+2+"%")),n&&189==e.keyCode&&(e.preventDefault(),this.book.setStyle("fontSize",t-2+"%")),n&&48==e.keyCode&&(e.preventDefault(),this.book.setStyle("fontSize","100%")))},EPUBJS.Reader.prototype.addBookmark=function(e){-1<this.isBookmarked(e)||(this.settings.bookmarks.push(e),this.trigger("reader:bookmarked",e))},EPUBJS.Reader.prototype.removeBookmark=function(e){var t=this.isBookmarked(e);-1!==t&&(this.settings.bookmarks.splice(t,1),this.trigger("reader:unbookmarked",t))},EPUBJS.Reader.prototype.isBookmarked=function(e){return this.settings.bookmarks.indexOf(e)},EPUBJS.Reader.prototype.clearBookmarks=function(){this.settings.bookmarks=[]},EPUBJS.Reader.prototype.addNote=function(e){this.settings.annotations.push(e)},EPUBJS.Reader.prototype.removeNote=function(e){var t=this.settings.annotations.indexOf(e);-1!==t&&delete this.settings.annotations[t]},EPUBJS.Reader.prototype.clearNotes=function(){this.settings.annotations=[]},EPUBJS.Reader.prototype.setBookKey=function(e){return this.settings.bookKey||(this.settings.bookKey="epubjsreader:"+EPUBJS.VERSION+":"+window.location.host+":"+e),this.settings.bookKey},EPUBJS.Reader.prototype.isSaved=function(e){return!!localStorage&&null!==localStorage.getItem(this.settings.bookKey)},EPUBJS.Reader.prototype.removeSavedSettings=function(){if(!localStorage)return!1;localStorage.removeItem(this.settings.bookKey)},EPUBJS.Reader.prototype.applySavedSettings=function(){var e;if(!localStorage)return!1;try{e=JSON.parse(localStorage.getItem(this.settings.bookKey))}catch(e){return!1}return!!e&&(e.styles&&(this.settings.styles=EPUBJS.core.defaults(this.settings.styles||{},e.styles)),this.settings=EPUBJS.core.defaults(this.settings,e),!0)},EPUBJS.Reader.prototype.saveSettings=function(){if(this.book&&(this.settings.previousLocationCfi=this.rendition.currentLocation().start.cfi),!localStorage)return!1;localStorage.setItem(this.settings.bookKey,JSON.stringify(this.settings))},EPUBJS.Reader.prototype.unload=function(){this.settings.restore&&localStorage&&this.saveSettings()},EPUBJS.Reader.prototype.hashChanged=function(){var e=window.location.hash.slice(1);this.rendition.display(e)},EPUBJS.Reader.prototype.selectedRange=function(e){var t="#"+e;this.settings.history&&window.location.hash!=t&&(history.pushState({},"",t),this.currentLocationCfi=e)},RSVP.EventTarget.mixin(EPUBJS.Reader.prototype),EPUBJS.reader.BookmarksController=function(){function n(e){var t=document.createElement("li"),n=document.createElement("a");t.id="bookmark-"+a,t.classList.add("list_item");var r,o=i.spine.get(e);return o.index in i.navigation.toc?(r=i.navigation.toc[o.index],n.textContent=r.label):n.textContent=e,n.href=e,n.classList.add("bookmark_link"),n.addEventListener("click",function(e){var t=this.getAttribute("href");s.display(t),e.preventDefault()},!1),t.appendChild(n),a++,t}var i=this.book,s=this.rendition,e=$("#bookmarksView"),r=e.find("#bookmarks"),o=document.createDocumentFragment(),a=0;return this.settings.bookmarks.forEach(function(e){var t=n(e);o.appendChild(t)}),r.append(o),this.on("reader:bookmarked",function(e){var t=n(e);r.append(t)}),this.on("reader:unbookmarked",function(e){$("#bookmark-"+e).remove()}),{show:function(){e.show()},hide:function(){e.hide()}}},EPUBJS.reader.ControlsController=function(e){var r=this,t=this.rendition,n=($("#store"),$("#fullscreen")),o=($("#fullscreenicon"),$("#cancelfullscreenicon"),$("#slider")),i=($("#main"),$("#sidebar"),$("#settings")),s=$("#bookmark");return o.on("click",function(){r.sidebarOpen?(r.SidebarController.hide(),o.addClass("icon-menu"),o.removeClass("icon-right")):(r.SidebarController.show(),o.addClass("icon-right"),o.removeClass("icon-menu"))}),"undefined"!=typeof screenfull&&(n.on("click",function(){screenfull.toggle($("#container")[0])}),screenfull.raw&&document.addEventListener(screenfull.raw.fullscreenchange,function(){fullscreen=screenfull.isFullscreen,fullscreen?n.addClass("icon-resize-small").removeClass("icon-resize-full"):n.addClass("icon-resize-full").removeClass("icon-resize-small")})),i.on("click",function(){r.SettingsController.show()}),s.on("click",function(){var e=r.rendition.currentLocation().start.cfi;-1===r.isBookmarked(e)?(r.addBookmark(e),s.addClass("icon-bookmark").removeClass("icon-bookmark-empty")):(r.removeBookmark(e),s.removeClass("icon-bookmark").addClass("icon-bookmark-empty"))}),t.on("relocated",function(e){var t=e.start.cfi,n="#"+t;-1===r.isBookmarked(t)?s.removeClass("icon-bookmark").addClass("icon-bookmark-empty"):s.addClass("icon-bookmark").removeClass("icon-bookmark-empty"),r.currentLocationCfi=t,r.settings.history&&window.location.hash!=n&&history.pushState({},"",n)}),{}},EPUBJS.reader.MetaController=function(e){var t=e.title,n=e.creator,r=$("#book-title"),o=$("#chapter-title"),i=$("#title-seperator");document.title=t+" – "+n,r.html(t),o.html(n),i.show()},EPUBJS.reader.NotesController=function(){function e(){t.show()}var c=this.book,h=this.rendition,p=this,t=$("#notesView"),r=$("#notes"),l=$("#note-text"),u=$("#note-anchor"),o=p.settings.annotations,m=c.renderer,y=[],d=new ePub.CFI,f=function(e){var t,n,r,o,i,s=c.renderer.doc;if(s.caretPositionFromPoint?(n=(t=s.caretPositionFromPoint(e.clientX,e.clientY)).offsetNode,r=t.offset):s.caretRangeFromPoint&&(n=(t=s.caretRangeFromPoint(e.clientX,e.clientY)).startContainer,r=t.startOffset),3!==n.nodeType)for(var a=0;a<n.childNodes.length;a++)if(3==n.childNodes[a].nodeType){n=n.childNodes[a];break}-1===(r=n.textContent.indexOf(".",r))?r=n.length:r+=1,o=d.generateCfiFromTextNode(n,r,c.renderer.currentChapter.cfiBase),i={annotatedAt:new Date,anchor:o,body:l.val()},p.addNote(i),v(i),g(i),l.val(""),u.text("Attach"),l.prop("disabled",!1),h.off("click",f)},v=function(e){var t=document.createElement("li"),n=document.createElement("a");t.innerHTML=e.body,n.innerHTML=" context &#187;",n.href="#"+e.anchor,n.onclick=function(){return h.display(e.anchor),!1},t.appendChild(n),r.append(t)},g=function(e){var t=c.renderer.doc,n=document.createElement("span"),r=document.createElement("a");n.classList.add("footnotesuperscript","reader_generated"),n.style.verticalAlign="super",n.style.fontSize=".75em",n.style.lineHeight="1em",r.style.padding="2px",r.style.backgroundColor="#fffa96",r.style.borderRadius="5px",r.style.cursor="pointer",n.id="note-"+EPUBJS.core.uuid(),r.innerHTML=o.indexOf(e)+1+"[Reader]",n.appendChild(r),d.addMarker(e.anchor,t,n),i(n,e.body)},i=function(a,c){var l=a.id,u=function(){y[l].classList.add("on")},d=function(){y[l].classList.remove("on")},f=function(){setTimeout(function(){y[l].classList.remove("show")},100)};a.addEventListener("mouseover",function(){var e,t,n,r,o=m.height,i=m.width,s=225;y[l]||(y[l]=document.createElement("div"),y[l].setAttribute("class","popup"),pop_content=document.createElement("div"),y[l].appendChild(pop_content),pop_content.innerHTML=c,pop_content.setAttribute("class","pop_content"),m.render.document.body.appendChild(y[l]),y[l].addEventListener("mouseover",u,!1),y[l].addEventListener("mouseout",d,!1),h.on("locationChanged",f,this),h.on("locationChanged",d,this)),e=y[l],n=(t=a.getBoundingClientRect()).left,r=t.top,e.classList.add("show"),popRect=e.getBoundingClientRect(),e.style.left=n-popRect.width/2+"px",e.style.top=r+"px",o/2.5<s&&(s=o/2.5,pop_content.style.maxHeight=s+"px"),popRect.height+r>=o-25?(e.style.top=r-popRect.height+"px",e.classList.add("above")):e.classList.remove("above"),n-popRect.width<=0?(e.style.left=n+"px",e.classList.add("left")):e.classList.remove("left"),n+popRect.width/2>=i?(e.style.left=n-300+"px",popRect=e.getBoundingClientRect(),e.style.left=n-popRect.width+"px",popRect.height+r>=o-25?(e.style.top=r-popRect.height+"px",e.classList.add("above")):e.classList.remove("above"),e.classList.add("right")):e.classList.remove("right")},!1),a.addEventListener("mouseout",f,!1),a.addEventListener("click",function(){p.ReaderController.slideOut(),e()},!1)};return u.on("click",function(e){u.text("Cancel"),l.prop("disabled","true"),h.on("click",f)}),o.forEach(function(e){v(e)}),{show:e,hide:function(){t.hide()}}},EPUBJS.reader.ReaderController=function(t){function n(){o.addClass("show")}function e(e){37==e.keyCode&&("rtl"===t.package.metadata.direction?l.next():l.prev(),a.addClass("active"),!0,setTimeout(function(){!1,a.removeClass("active")},100),e.preventDefault()),39==e.keyCode&&("rtl"===t.package.metadata.direction?l.prev():l.next(),s.addClass("active"),!0,setTimeout(function(){!1,s.removeClass("active")},100),e.preventDefault())}var r=$("#main"),o=$("#divider"),i=$("#loader"),s=$("#next"),a=$("#prev"),c=this,l=(t=this.book,this.rendition),u=function(){o.removeClass("show")};return document.addEventListener("keydown",e,!1),s.on("click",function(e){"rtl"===t.package.metadata.direction?l.prev():l.next(),e.preventDefault()}),a.on("click",function(e){"rtl"===t.package.metadata.direction?l.next():l.prev(),e.preventDefault()}),l.on("layout",function(e){!0===e.spread?n():u()}),l.on("relocated",function(e){e.atStart&&a.addClass("disabled"),e.atEnd&&s.addClass("disabled")}),{slideOut:function(){c.settings.sidebarReflow?(r.addClass("single"),r.one("transitionend",function(){l.resize()})):r.addClass("closed")},slideIn:function(){c.settings.sidebarReflow?(r.removeClass("single"),r.one("transitionend",function(){l.resize()})):r.removeClass("closed")},showLoader:function(){i.show(),u()},hideLoader:function(){i.hide()},showDivider:n,hideDivider:u,arrowKeys:e}},EPUBJS.reader.SettingsController=function(){this.book;function e(){n.removeClass("md-show")}var t=this,n=$("#settings-modal"),r=$(".overlay");return $("#sidebarReflow").on("click",function(){t.settings.sidebarReflow=!t.settings.sidebarReflow}),n.find(".closer").on("click",function(){e()}),r.on("click",function(){e()}),{show:function(){n.addClass("md-show")},hide:e}},EPUBJS.reader.SidebarController=function(e){function n(e){var t=e+"Controller";i!=e&&void 0!==r[t]&&(r[i+"Controller"].hide(),r[t].show(),i=e,o.find(".active").removeClass("active"),o.find("#show-"+e).addClass("active"))}var r=this,t=$("#sidebar"),o=$("#panels"),i="Toc";return o.find(".show_view").on("click",function(e){var t=$(this).data("view");n(t),e.preventDefault()}),{show:function(){r.sidebarOpen=!0,r.ReaderController.slideOut(),t.addClass("open")},hide:function(){r.sidebarOpen=!1,r.ReaderController.slideIn(),t.removeClass("open")},getActivePanel:function(){return i},changePanelTo:n}},EPUBJS.reader.TocController=function(e){this.book;var n=this.rendition,o=$("#tocView").empty(),t=document.createDocumentFragment(),s=function(e,o){var i=document.createElement("ul");return o=o||1,e.forEach(function(e){var t,n=document.createElement("li"),r=document.createElement("a");toggle=document.createElement("a"),n.id="toc-"+e.id,n.classList.add("list_item"),r.textContent=e.label,r.href=e.href,r.classList.add("toc_link"),n.appendChild(r),e.subitems&&0<e.subitems.length&&(o++,t=s(e.subitems,o),toggle.classList.add("toc_toggle"),n.insertBefore(toggle,r),n.appendChild(t)),i.appendChild(n)}),i};n.on("renderered",function(e){var t=e.id,n=o.find("#toc-"+t),r=o.find(".currentChapter");o.find(".openChapter");n.length&&(n!=r&&0<n.has(!1).length&&r.removeClass("currentChapter"),n.addClass("currentChapter"),n.parents("li").addClass("openChapter"))});var r=s(e);return t.appendChild(r),o.append(t),o.find(".toc_link").on("click",function(e){var t=this.getAttribute("href");e.preventDefault(),n.display(t),o.find(".currentChapter").addClass("openChapter").removeClass("currentChapter"),$(this).parent("li").addClass("currentChapter")}),o.find(".toc_toggle").on("click",function(e){var t=$(this).parent("li"),n=t.hasClass("openChapter");e.preventDefault(),n?t.removeClass("openChapter"):t.addClass("openChapter")}),{show:function(){o.show()},hide:function(){o.hide()}}},EPUBJS.reader.UploadController=function(){document.getElementById("upload").addEventListener("change",function(e){if(0!==e.target.files.length)if(window.FileReader){var t=new FileReader;t.readAsArrayBuffer(e.target.files[0]),t.onload=function(e){ePubReader(e.target.result,{restore:!0})}}else alert("Your browser does not support the required features.\nPlease use a modern browser such as Google Chrome, or Mozilla Firefox.")},!1)};